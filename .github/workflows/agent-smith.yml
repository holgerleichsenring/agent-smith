# Agent Smith - Automated Issue Handler
# Trigger: Add the 'agent-smith' label to any GitHub issue.
# Agent Smith will clone the repo, generate a plan, implement changes,
# run tests, and create a pull request.
#
# Required secrets:
#   ANTHROPIC_API_KEY  - for Claude provider (or OPENAI_API_KEY / GEMINI_API_KEY)
#   AGENT_SMITH_TOKEN  - GitHub PAT with repo + issues permissions
#                        (GITHUB_TOKEN works but can't trigger other workflows on the PR)

name: Agent Smith

on:
  issues:
    types: [labeled]

jobs:
  agent-smith:
    if: github.event.label.name == 'agent-smith'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build Agent Smith
        run: dotnet build --configuration Release --verbosity quiet

      - name: Run Agent Smith
        env:
          GITHUB_TOKEN: ${{ secrets.AGENT_SMITH_TOKEN || secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          dotnet run --project src/AgentSmith.Host \
            --configuration Release \
            -- \
            --headless \
            "fix #${{ github.event.issue.number }} in ${{ github.event.repository.name }}"
